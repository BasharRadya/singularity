# Lecture 8 - 5 October 2023

## IMPORTANT ANNOUNCEMENT
<marquee><h5> errerewerewrerewwwe... the following is a test of the emergency broadcast system. errrrrwerwererwerwe ... ....</h5></marquee>

The instructors are willing to spend more time helping studenst who take initiative and less patient when asked questions for which the answers are *very* easily available by a web search at 11 PM on a due date. If you made it this far in computer science, should have at least moderate proficnency in searching the internet for the solution to your computer problems.

**BEFORE** you contact an instructor about a problem you are having, the expectation is that:

* You have thoroughy read the assignment instructions
* You have proofread your command or code for typos
* If something has failed, you have read the error messsage and you have it ready to send to the instructor
* You read any relevant man pages or documentation
* You have searched the web for solutions

**IF** you are able to solve your own problem, but you think that:

* The directions are incorrect
* The diretions could be made clearer
* There is a bug in our course infrastructure
* You have an idea for a feature that could improve the course quality

Then, we invite you to contact us and we will appreciate your participation and take it into account. But if you are interset in contributing your change to our open source project that is the entire course, we will guide you through the process of making, testing, and submitting the change. Student who go this extra mile and complete the process will be given extra credit in our couse and public recognition for their contribtion.

Keep in mind that this policy coversy _anything_ in the course, including code, scripts, process, curriculum, formatting, style, security, design, testing, automation, devops, site reliability, IT, or any other aspect that you can imagine and convince is a part of the course.

**HOWEVER**, if you are still stuck and you have tried a couple of solutions, include _ALL_ of the following in your request for help:

* What you were doing when the error occured, that is to say, what specific steps did you take that we can take to see the same error.
* Any input or output remotely relevant to the error, include as applicable all of the following:
  * The command you ran and the output
  * The complete source code for and error message and Makefile and Makefile invocation either inline or as a clonable repo link
  * Any dmesg or system log messages that seem relevant to the error
* Any references or resouces you consulted during your troubleshooting, e.g. mangpages, websites, respositories, documentation
* What you tried to do to fix your probem
* Your best educated guess or guesses as to what's wrong.

The more complete this information is when you ask for help, the more generous and flexible the instructors will be in their effor to help you.

You **will** get out of this couse what you put into it.

And now back to your regularly scheduled programming.

## Topics covered:

* Assiginment questions
* Syscalls: there and back again

### Assignment Questions

A student asked us to clarify the
[P1](https://kdlp.underground.software/course/fall2023/assignments/P1.md)
due date.

P1 is **NOT** due next Tuesday. We want to give you plenty of time to do P1 since it's a bit more involved than E1. As a reminder, P assignments are the most
[heavily weighted](https://kdlp.underground.software/course/fall2023/policies/course_policies.md)
component of the course outside of the final assignment and presentation combo.

As always, we encourage you to get started early so you have plenty of time to take breaks when you run into problems and later return to your work with a fresh mind.

Next, a student asked when their grades will be avilable. E0 grades are available upon request via Matrix DM to one of the instructors. P0 grades are not yet available and any new information will be made available as soon as it is ready.

The instructors wish to contratulate our students. This group delivered the all-time strongest average performance on the kernel compilation assignment! Nice job!


### Syscalls: there and back again

First, we reviewed exceptions.

Start off reviewing exceptions from last time

Note URL: https://wiki.osdev.org/Exceptions#Page_Fault

We use page fault as example

Next we return to the kernel syscall implementation

syscall inst. loads RIP from LSTAR MSR

Next, the read(2) SYSCALL_DEFINE maro call site
(edited)

Objective for this class: Trace how the systemcall gets from user to kernel and back

msr-index.h

MSR_LSTAR

syscall_init

q: wrmsrl???

what is

idk

guess????

some kind of raw, underlying read thing

not many guesses

One student (unknown but indian accent): read & write?

then we look at entry_SYSCALL_64

joel One student (unknown but indian accent): read & write?

Viet
entry_SYSCALL_64

what is???

guess???

function pointer

not sure who answered

syscall_init => entry_SYSCALL_64

open: entry_64.S
(edited)

important note on assembly: raw assembly doesn't have any info about where functions start and end

just labels

preprocessor macros used to markup the file "dynamically" -- in context of kbuild

.S vs .s: former needs some cpp and latter does not
it's kinda jank/questionable abuse of cpp
but hey it works

very fast and simple

assembly pre-processing trade offs: simplicity and familiarity vs lots of features

(edited)

Linux goes for the former

Demo of running cpp on generic hello world C file
man cpp is useful
called by gcc
*.i is "intermediate file" and is conventional ext. for cpp output
output has lots of line number markup bits

looking at the actual declarations in stdio.h that end up in the output

cpp removes comments
Viet: what step of compilation invokes cpp?
gcc -c will still do cpp
it's before linking

and before compilation

cpp/preprocess(source) => .i

(edited)

"gcc -c"/compile(.i) => .s
(edited)

assemble(.s) => .o

ld/collect2/link(.o) => executable binary

(edited)

Now the linux kernel loader will be able to take that final output and turn it into a running task

(edited)

back to entry_64.S

gets called when CPU executes syscall

